<launch>
  <arg name="ns" default="/"/>
  <arg name="fcu_url" default="udp://:14540@localhost:14557"/>
  <arg name="gcs_url" default="" />   <!-- GCS link is provided by SITL -->
  <arg name="tgt_system" default="1" />
  <arg name="tgt_component" default="1" />

  <arg name="image_topic" default="/stereo/left/image_rect_color"/>
  <arg name="camera_info_topic" default="/stereo/left/camera_info"/>
  <arg name="odom_topic" default="/mavros/local_position/odom"/>
  <arg name="point_topic" default="/yolov5/gate/point"/>
  <arg name="optitrack_topic" default="/mavros/vision_pose/pose"/>
  
  <!-- <arg name="autopilot/reference_pose" default="/move_base_simple/goal"/> -->
  <arg name="autopilot/reference_pose" default="autopilot/reference_pose"/>
  <arg name="autopilot/reference_trajectory" default="autopilot/reference_trajectory"/>

  <arg name="world_file_name" default="apriltag_pattern" />  
  <arg name="world_path" default="$(find px4_ros)/sim/worlds/$(arg world_file_name).world" />
  <arg name="gui" default="true"/>
  <arg name="model" default="iris_stereo_camera"/>
  <arg name="vehicle" default="iris_obs_avoid"/>

  <arg name="use_apriltag" default="false"/>
  <arg name="use_motion_capture" default="false"/>

  <!-- Launch MavROS -->
  <group ns="$(arg ns)">
    <include file="$(find mavros)/launch/node.launch">
      <arg name="pluginlists_yaml" value="$(find mavros)/launch/px4_pluginlists.yaml" />
      <!-- Need to change the config file to get the tf topic and get local position in terms of local origin -->
      <arg name="config_yaml" value="$(find px4_ros)/resource/px4_config.yaml" />
      <arg name="fcu_url" value="$(arg fcu_url)" />
      <arg name="gcs_url" value="$(arg gcs_url)" />
      <arg name="tgt_system" value="$(arg tgt_system)" />
      <arg name="tgt_component" value="$(arg tgt_component)" />
    </include>
  </group>

  <!-- Launch cameras -->
  <!-- Define a static transform from a camera internal frame to the fcu for every camera used -->
  <node pkg="tf" type="static_transform_publisher" name="tf_depth_camera"
          args="0 0 0 -1.57 0 -1.57 fcu camera_link 10"/>
  <node ns="stereo" pkg="stereo_image_proc" type="stereo_image_proc" name="stereo_image_proc">
    <param name="stereo_algorithm" type="double" value="1.0" />
    <param name="correlation_window_size" type="double" value="19.0" />
    <param name="disparity_range" type="double" value="32.0" />
    <param name="uniqueness_ratio" type="double" value="40.0" />
    <param name="speckle_size" type="double" value="1000.0" />
    <param name="speckle_range" type="double" value="2.0" />
  </node>

  <!-- Launch PX4 SITL -->
  <include file="$(find px4)/launch/px4.launch">
    <arg name="vehicle" value="$(arg vehicle)"/>
  </include>

  <!-- Launch Gazebo -->
  <include file="$(find gazebo_ros)/launch/empty_world.launch">
    <arg name="gui" value="$(arg gui)"/>
    <arg name="world_name" value="$(arg world_path)" />
  </include>

  <!-- Spawn vehicle model -->
  <node name="spawn_model" pkg="gazebo_ros" type="spawn_model" output="screen"
    args="-sdf -database $(arg model) -model $(arg vehicle)">
  </node>

  <!-- Load custom console configuration -->
  <!-- <env name="ROSCONSOLE_CONFIG_FILE" value="$(find px4_ros)/resource/custom_rosconsole.conf"/> -->

  <!-- Launch Rviz -->
  <node name="rviz" pkg="rviz" type="rviz" output="screen" args="-d $(find fsc_autopilot)/rviz/px4_autopilot.rviz" />

  <!-- Launch autopilot -->
  <node pkg="fsc_autopilot" name="fsc_pixhawk_node" type="fsc_pixhawk_node" output="screen" >
    <remap from="odom_topic" to="$(arg odom_topic)" />
    <remap from="point_topic" to="$(arg point_topic)" />
    <remap from="optitrack_topic" to="$(arg optitrack_topic)" />
    <remap from="autopilot/reference_pose" to="$(arg autopilot/reference_pose)" />
    <remap from="autopilot/reference_trajectory" to="$(arg autopilot/reference_trajectory)" />
    <param name="use_motion_capture" type="bool" value="$(arg use_motion_capture)" />
    <rosparam file="$(find fsc_autopilot)/parameters/px4_control_params.yaml" />
    <rosparam file="$(find flight_system)/parameters/pixhawk_params.yaml" />
    <rosparam file="$(find fsc_autopilot)/parameters/pixracer.yaml" />
  </node>

  <!-- Launch px4 booter -->
  <include file="$(find px4_booter)/launch/run_px4_booter.launch">
  </include>

  <!-- Launch param tuner -->
  <node pkg="param_tuner" name="param_tuner_node" type="param_tuner_node" output="screen" >
  </node>

  <!-- Launch rqt_reconfigure -->
  <node pkg="rqt_reconfigure" type="rqt_reconfigure" output="screen" name="rqt_reconfigure" />

  <arg name="bbox_topic" default="/yolov5/detections"/>
  <!-- Launch bbox_generator_node -->
  <node pkg="fsc_tracker" name="bbox_generator_node" type="bbox_generator_node" output="screen" >
    <remap from="odom_topic" to="$(arg odom_topic)" />
    <remap from="bbox_topic" to="$(arg bbox_topic)" />
    <rosparam file="$(find fsc_autopilot)/parameters/px4_tracker_params.yaml" />
  </node>

  <!-- Launch tracker_node -->
  <node pkg="fsc_tracker" name="tracker_node" type="tracker_node" output="screen" >
    <remap from="odom_topic" to="$(arg odom_topic)" />
    <remap from="bbox_topic" to="$(arg bbox_topic)" />
    <remap from="point_topic" to="$(arg point_topic)" />
    <rosparam file="$(find fsc_autopilot)/parameters/px4_tracker_params.yaml" />
  </node>


</launch>